<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            background: var(--vscode-sideBar-background);
            color: var(--vscode-sideBar-foreground);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 8px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            background: var(--vscode-sideBarSectionHeader-background);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h3 {
            font-size: 13px;
            font-weight: 600;
            margin: 0;
        }

        .new-chat-btn {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .new-chat-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .sessions-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sessions-list {
            border-bottom: 1px solid var(--vscode-panel-border);
            max-height: 40vh;
            overflow-y: auto;
        }

        .session-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--vscode-panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-item:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .session-item.active {
            background: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
        }

        .session-info {
            flex: 1;
            min-width: 0;
        }

        .session-title {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-preview {
            font-size: 10px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .session-item:hover .session-actions {
            opacity: 1;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 2px;
            border-radius: 2px;
            font-size: 12px;
        }

        .action-btn:hover {
            background: var(--vscode-toolbar-hoverBackground);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .model-selector-container {
            padding: 8px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            background: var(--vscode-sideBarSectionHeader-background);
        }

        .model-selector {
            width: 100%;
            background: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 11px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 90%;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .message.assistant {
            align-self: flex-start;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
        }

        .thinking-indicator {
            align-self: flex-start;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            padding: 8px 12px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 8px;
            font-style: italic;
        }

        .thinking-dots {
            display: flex;
            gap: 2px;
        }

        .thinking-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.4;
            animation: thinking 1.4s ease-in-out infinite both;
        }

        .thinking-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes thinking {

            0%,
            80%,
            100% {
                opacity: 0.4;
            }

            40% {
                opacity: 1;
            }
        }

        .input-container {
            padding: 8px 16px;
            border-top: 1px solid var(--vscode-panel-border);
            display: flex;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            padding: 6px 8px;
            font-size: 12px;
            resize: none;
            min-height: 20px;
            max-height: 80px;
        }

        .send-btn {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 3px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--vscode-button-hoverBackground);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--vscode-descriptionForeground);
            gap: 8px;
            padding: 16px;
        }

        .empty-icon {
            font-size: 32px;
            opacity: 0.6;
        }

        .empty-text {
            font-size: 12px;
            font-weight: 500;
        }

        .empty-subtitle {
            font-size: 11px;
            opacity: 0.8;
        }

        .error-container {
            padding: 12px 16px;
            background-color: var(--vscode-errorForeground);
            color: var(--vscode-input-foreground);
            opacity: 0.8;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .error-details {
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .error-action-btn {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid var(--vscode-button-border);
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .error-action-btn:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }
    </style>
</head>

<body>
    <div class="header">
        <h3>Chat</h3>
        <button class="new-chat-btn" onclick="newChat()">+ New</button>
    </div>

    <div class="sessions-container">
        <div class="sessions-list" id="sessionsList">
            <!-- Sessions will be populated here -->
        </div>

        <div class="chat-area">
            <div class="model-selector-container">
                <select class="model-selector" id="modelSelector">
                    <option value="">Loading models...</option>
                </select>
            </div>

            <div class="error-message" id="errorMessage"
                style="display: none; color: var(--vscode-errorForeground); background: var(--vscode-inputValidation-errorBackground); border: 1px solid var(--vscode-inputValidation-errorBorder); padding: 8px; margin: 8px 16px; border-radius: 4px; font-size: 12px;">
                <div class="error-title" id="errorTitle">Error</div>
                <div class="error-details" id="errorDetails">Error details</div>
                <button class="error-action-btn" id="errorActionBtn" style="display: none;">Run Diagnostics</button>
            </div>

            <div id="messagesContainer" class="messages-container">
                <div id="emptyState" class="empty-state">
                    <div class="empty-icon">🌊</div>
                    <div class="empty-text">Select or create a chat</div>
                    <div class="empty-subtitle">Wu wei - effortless conversation</div>
                </div>
                <div class="thinking-indicator" id="thinkingIndicator">
                    <span>Wu Wei is contemplating...</span>
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <textarea class="message-input" id="messageInput" placeholder="Loading..." rows="1" disabled></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        let sessions = [];
        let currentSessionId = null;
        let messages = [];
        let availableModels = [];

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 80) + 'px';
        });

        // Send on Enter
        document.getElementById('messageInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Model selector
        document.getElementById('modelSelector').addEventListener('change', function () {
            if (this.value) {
                vscode.postMessage({
                    command: 'selectModel',
                    modelFamily: this.value
                });
            }
        });

        function newChat() {
            vscode.postMessage({ command: 'newChat' });
        }

        function selectSession(sessionId) {
            vscode.postMessage({
                command: 'selectSession',
                sessionId: sessionId
            });
        }

        function deleteSession(sessionId, event) {
            event.stopPropagation();
            vscode.postMessage({
                command: 'deleteSession',
                sessionId: sessionId
            });
        }

        function renameSession(sessionId, event) {
            event.stopPropagation();
            const newName = prompt('Enter new name:');
            if (newName && newName.trim()) {
                vscode.postMessage({
                    command: 'renameSession',
                    sessionId: sessionId,
                    newName: newName.trim()
                });
            }
        }

        document.getElementById('errorActionBtn').addEventListener('click', () => {
            vscode.postMessage({ command: 'runDiagnostics' });
        });

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message immediately
            addMessage(message, true);
            input.value = '';
            input.style.height = 'auto';

            vscode.postMessage({
                command: 'sendMessage',
                text: message
            });
        }

        function addMessage(text, isUser) {
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');

            if (emptyState.style.display !== 'none') {
                emptyState.style.display = 'none';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            messageDiv.textContent = text;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function updateSessions(sessionData) {
            sessions = sessionData;
            const sessionsList = document.getElementById('sessionsList');
            sessionsList.innerHTML = '';

            sessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = `session-item ${session.id === currentSessionId ? 'active' : ''}`;
                sessionDiv.onclick = () => selectSession(session.id);

                sessionDiv.innerHTML = `
                    <div class="session-info">
                        <div class="session-title">${session.title}</div>
                        <div class="session-preview">${session.lastMessage || 'No messages'}</div>
                    </div>
                    <div class="session-actions">
                        <button class="action-btn" onclick="renameSession('${session.id}', event)" title="Rename">✏️</button>
                        <button class="action-btn" onclick="deleteSession('${session.id}', event)" title="Delete">🗑️</button>
                    </div>
                `;

                sessionsList.appendChild(sessionDiv);
            });
        }

        function updateMessages(messageData) {
            messages = messageData;
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');
            const thinkingIndicator = document.getElementById('thinkingIndicator');

            // Clear existing messages (except empty state and thinking indicator)
            const messagesToRemove = container.querySelectorAll('.message');
            messagesToRemove.forEach(msg => msg.remove());

            if (messages.length === 0) {
                emptyState.style.display = 'flex';
            } else {
                emptyState.style.display = 'none';
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user' : 'assistant'}`;
                    messageDiv.textContent = msg.content;
                    container.insertBefore(messageDiv, thinkingIndicator);
                });
            }

            container.scrollTop = container.scrollHeight;
        }

        function updateModels(modelData, currentModel, loading, error) {
            console.log('updateModels called:', { modelData, currentModel, loading, error });

            availableModels = modelData;
            const selector = document.getElementById('modelSelector');
            selector.innerHTML = '';

            // Handle loading state
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            if (loading === false) {
                console.log('Clearing loading state - enabling input');
                input.disabled = false;
                sendBtn.disabled = false;
                input.placeholder = 'Type your message...';
            }

            // Show error if any
            const errorContainer = document.getElementById('errorMessage');
            const errorTitle = document.getElementById('errorTitle');
            const errorDetails = document.getElementById('errorDetails');
            const errorActionBtn = document.getElementById('errorActionBtn');

            if (error) {
                errorTitle.textContent = error.message || 'An error occurred.';
                errorDetails.textContent = error.details || '';
                if (error.actionable) {
                    errorActionBtn.style.display = 'inline-block';
                } else {
                    errorActionBtn.style.display = 'none';
                }
                errorContainer.style.display = 'block';
            } else {
                errorContainer.style.display = 'none';
            }

            if (modelData.length === 0) {
                selector.innerHTML = '<option value="">No models available</option>';
                return;
            }

            modelData.forEach(model => {
                const option = document.createElement('option');
                option.value = model.family;
                option.textContent = `${model.family} (${model.vendor})`;
                if (model.family === currentModel) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.command) {
                case 'updateState':
                    currentSessionId = message.currentSessionId;
                    updateSessions(message.sessions);
                    updateMessages(message.messages);
                    break;
                case 'addMessage':
                    addMessage(message.message, message.isUser);
                    break;
                case 'showThinking':
                    document.getElementById('thinkingIndicator').style.display = 'flex';
                    document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
                    break;
                case 'hideThinking':
                    document.getElementById('thinkingIndicator').style.display = 'none';
                    break;
                case 'updateModels':
                    updateModels(message.models, message.currentModel, message.loading, message.error);
                    break;
                case 'setLoadingState':
                    console.log('setLoadingState called:', message.loading);
                    const input = document.getElementById('messageInput');
                    const sendBtn = document.getElementById('sendBtn');
                    if (message.loading) {
                        console.log('Setting loading state - disabling input');
                        input.disabled = true;
                        sendBtn.disabled = true;
                        input.placeholder = 'Loading...';
                    } else {
                        console.log('Clearing loading state - enabling input');
                        input.disabled = false;
                        sendBtn.disabled = false;
                        input.placeholder = 'Type your message...';
                    }
                    break;
            }
        });

        // Request initial state
        vscode.postMessage({ command: 'requestModels' });
    </script>
</body>

</html>