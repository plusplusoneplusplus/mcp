name: Package Wu Wei Extension

on:
  schedule:
    - cron: "0 0 * * *"  # Every day at midnight UTC
  workflow_dispatch:

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Use Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: wu-wei/package-lock.json

    - name: Install dependencies
      run: |
        cd wu-wei
        npm ci

    - name: Install vsce
      run: npm install -g @vscode/vsce

    - name: Package extension (bundled)
      run: |
        cd wu-wei
        npm run package
        vsce package

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: wu-wei-extension
        path: wu-wei/*.vsix

    - name: Bump version and create PR
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd wu-wei
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Bump patch version
        npm version patch --no-git-tag-version

        # Get the new version
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

        # Create a new branch for the version bump
        BRANCH_NAME="chore/bump-version-v$NEW_VERSION"
        git checkout -b "$BRANCH_NAME"

        # Commit the version bump
        git add package.json
        git commit -m "chore: bump version to v$NEW_VERSION"

        # Push the branch
        git push origin "$BRANCH_NAME"

        # Create pull request using GitHub CLI
        PR_URL=$(gh pr create \
          --title "chore: bump version to v$NEW_VERSION" \
          --body "Automated version bump after successful package build.

        **Changes:**
        - Bump version from previous version to v$NEW_VERSION in package.json

        This PR was automatically created by the package-extension workflow." \
          --base main \
          --head "$BRANCH_NAME" \
          --label "automated" \
          --label "version-bump")

        # Enable auto-merge with squash strategy
        gh pr merge "$PR_URL" --auto --squash
