{% extends "base.html" %}

{% block title %}DataFrames - MCP Knowledge Server{% endblock %}

{% block extra_styles %}
<style>
    /* Dashboard-specific styles */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2em;
        flex-wrap: wrap;
        gap: 1em;
    }

    .dashboard-title {
        margin: 0;
        color: #333;
    }

    .dashboard-actions {
        display: flex;
        gap: 0.5em;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.5em 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5em;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #0077cc;
        color: white;
    }

    .btn-primary:hover {
        background: #005fa3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #1e7e34;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Storage statistics */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1em;
        margin-bottom: 2em;
    }

    .stat-card {
        background: white;
        padding: 1.5em;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #0077cc;
        margin-bottom: 0.25em;
    }

    .stat-label {
        color: #666;
        font-size: 0.9em;
    }

    .stat-card.warning .stat-value {
        color: #ffc107;
    }

    .stat-card.danger .stat-value {
        color: #dc3545;
    }

    /* DataFrame table */
    .dataframes-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table-header {
        background: #f8f9fa;
        padding: 1em;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1em;
    }

    .table-title {
        margin: 0;
        font-size: 1.2em;
        color: #333;
    }

    .table-controls {
        display: flex;
        gap: 0.5em;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-box {
        padding: 0.5em;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9em;
        min-width: 200px;
    }

    .dataframes-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
    }

    .dataframes-table th,
    .dataframes-table td {
        padding: 1em;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .dataframes-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #333;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .dataframes-table th:hover {
        background: #e9ecef;
    }

    .dataframes-table th.sortable::after {
        content: '‚Üï';
        position: absolute;
        right: 0.5em;
        opacity: 0.5;
    }

    .dataframes-table th.sort-asc::after {
        content: '‚Üë';
        opacity: 1;
    }

    .dataframes-table th.sort-desc::after {
        content: '‚Üì';
        opacity: 1;
    }

    .dataframes-table tr:hover {
        background: #f8f9fa;
    }

    .dataframes-table .actions {
        display: flex;
        gap: 0.5em;
        align-items: center;
    }

    .dataframes-table .btn {
        padding: 0.25em 0.5em;
        font-size: 0.8em;
    }

    /* Status badges */
    .status-badge {
        padding: 0.25em 0.5em;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-badge.active {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.expired {
        background: #f8d7da;
        color: #721c24;
    }

    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }

    /* Drag and drop upload area */
    .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 2em;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1em;
    }

    .upload-area:hover,
    .upload-area.dragover {
        border-color: #0077cc;
        background: #f0f8ff;
    }

    .upload-area.dragover {
        border-style: solid;
    }

    .upload-icon {
        font-size: 3em;
        color: #ccc;
        margin-bottom: 0.5em;
    }

    .upload-text {
        color: #666;
        margin-bottom: 1em;
    }

    .upload-hint {
        font-size: 0.8em;
        color: #999;
    }

    /* Progress indicators */
    .progress-container {
        margin: 1em 0;
    }

    .progress-bar-container {
        width: 100%;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
        height: 8px;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #0077cc, #28a745);
        transition: width 0.3s ease;
        width: 0%;
    }

    .progress-text {
        font-size: 0.8em;
        color: #666;
        margin-top: 0.25em;
    }

    /* Modal styles */
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1em;
        padding-bottom: 1em;
        border-bottom: 1px solid #eee;
    }

    .modal-title {
        margin: 0;
        color: #333;
    }

    .modal-body {
        margin-bottom: 2em;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5em;
        padding-top: 1em;
        border-top: 1px solid #eee;
    }

    .form-group {
        margin-bottom: 1em;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5em;
        font-weight: bold;
        color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.5em;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1em;
        box-sizing: border-box;
    }

    .form-group .form-help {
        font-size: 0.8em;
        color: #666;
        margin-top: 0.25em;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5em;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 3em;
        color: #666;
    }

    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 0.5em;
        opacity: 0.3;
    }

    .empty-state-title {
        font-size: 1.2em;
        margin-bottom: 0.5em;
        color: #333;
    }

    .empty-state-text {
        margin-bottom: 1.5em;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: stretch;
        }

        .dashboard-actions {
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .table-header {
            flex-direction: column;
            align-items: stretch;
        }

        .table-controls {
            justify-content: center;
        }

        .dataframes-table {
            font-size: 0.8em;
        }

        .dataframes-table th,
        .dataframes-table td {
            padding: 0.5em;
        }

        .search-box {
            min-width: auto;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h2 class="dashboard-title">DataFrames Dashboard</h2>
        <div class="dashboard-actions">
            <button class="btn btn-primary" onclick="showUploadModal()">
                üìÅ Upload File
            </button>
            <button class="btn btn-secondary" onclick="showUrlModal()">
                üåê Load from URL
            </button>
            <button class="btn btn-warning" onclick="cleanupExpired()">
                üßπ Cleanup Expired
            </button>
            <button class="btn btn-success" onclick="refreshDashboard()">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Storage Statistics -->
    <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-dataframes">-</div>
            <div class="stat-label">Total DataFrames</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-memory">-</div>
            <div class="stat-label">Memory Usage</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="expired-count">-</div>
            <div class="stat-label">Expired DataFrames</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="active-count">-</div>
            <div class="stat-label">Active DataFrames</div>
        </div>
    </div>

    <!-- DataFrames Table -->
    <div class="dataframes-table-container">
        <div class="table-header">
            <h3 class="table-title">DataFrames</h3>
            <div class="table-controls">
                <input type="text" class="search-box" id="search-box" placeholder="Search DataFrames..."
                    onkeyup="filterDataFrames()">
                <button class="btn btn-secondary" onclick="toggleBatchMode()">
                    <span id="batch-mode-text">Select Multiple</span>
                </button>
            </div>
        </div>

        <div id="dataframes-table-content">
            <!-- Table content will be loaded here -->
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-message" style="display: none; margin-top: 1em;"></div>
</div>

<!-- File Upload Modal -->
<div id="upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Upload Data File</h3>
            <span class="close" onclick="hideModal('upload-modal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">
                    <strong>Click to select files</strong> or drag and drop here
                </div>
                <div class="upload-hint">
                    Supported formats: CSV, JSON, Excel (.xlsx), Parquet
                </div>
            </div>
            <input type="file" id="file-input" style="display: none" accept=".csv,.json,.xlsx,.parquet" multiple>

            <div class="form-group">
                <label for="upload-display-name">Display Name (optional)</label>
                <input type="text" id="upload-display-name" placeholder="Custom name for the DataFrame">
                <div class="form-help">Leave empty to use filename</div>
            </div>

            <div class="form-group">
                <label for="upload-format">Format</label>
                <select id="upload-format">
                    <option value="auto">Auto-detect</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                    <option value="parquet">Parquet</option>
                </select>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="upload-has-header" checked>
                    <label for="upload-has-header">File has header row</label>
                </div>
            </div>

            <div id="upload-progress" class="progress-container" style="display: none;">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="upload-progress-bar"></div>
                </div>
                <div class="progress-text" id="upload-progress-text">Preparing upload...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('upload-modal')">Cancel</button>
            <button class="btn btn-primary" id="upload-btn" onclick="uploadFiles()">Upload</button>
        </div>
    </div>
</div>

<!-- URL Loading Modal -->
<div id="url-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Load Data from URL</h3>
            <span class="close" onclick="hideModal('url-modal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="url-input">Data URL</label>
                <input type="url" id="url-input" placeholder="https://example.com/data.csv" required>
                <div class="form-help">Enter the URL of a CSV, JSON, Excel, or Parquet file</div>
            </div>

            <div class="form-group">
                <label for="url-display-name">Display Name (optional)</label>
                <input type="text" id="url-display-name" placeholder="Custom name for the DataFrame">
            </div>

            <div class="form-group">
                <label for="url-format">Format</label>
                <select id="url-format">
                    <option value="auto">Auto-detect</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                    <option value="parquet">Parquet</option>
                </select>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="url-has-header" checked>
                    <label for="url-has-header">Data has header row</label>
                </div>
            </div>

            <div id="url-progress" class="progress-container" style="display: none;">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="url-progress-bar"></div>
                </div>
                <div class="progress-text" id="url-progress-text">Loading data...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('url-modal')">Cancel</button>
            <button class="btn btn-primary" id="url-load-btn" onclick="loadFromUrl()">Load Data</button>
        </div>
    </div>
</div>

<!-- Batch Operations Modal -->
<div id="batch-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Batch Operations</h3>
            <span class="close" onclick="hideModal('batch-modal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>Selected DataFrames: <span id="selected-count">0</span></p>
            <div id="selected-list"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('batch-modal')">Cancel</button>
            <button class="btn btn-danger" onclick="batchDelete()">Delete Selected</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Dashboard state
    let dataframes = [];
    let filteredDataframes = [];
    let sortColumn = 'created_at';
    let sortDirection = 'desc';
    let batchMode = false;
    let selectedDataframes = new Set();

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        setupEventListeners();
        refreshDashboard();
    });

    function setupEventListeners() {
        // File upload drag and drop
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            updateUploadPreview();
        });

        fileInput.addEventListener('change', updateUploadPreview);

        // Auto-detect format based on URL
        document.getElementById('url-input').addEventListener('input', function () {
            const url = this.value.toLowerCase();
            const formatSelect = document.getElementById('url-format');

            if (url.includes('.csv')) {
                formatSelect.value = 'csv';
            } else if (url.includes('.json')) {
                formatSelect.value = 'json';
            } else if (url.includes('.xlsx') || url.includes('.xls')) {
                formatSelect.value = 'excel';
            } else if (url.includes('.parquet')) {
                formatSelect.value = 'parquet';
            }
        });
    }

    async function refreshDashboard() {
        try {
            showLoading('dataframes-table-content', 'Loading DataFrames...');

            // Load DataFrames and statistics
            const [dataframesResponse, statsResponse] = await Promise.all([
                fetch('/api/dataframes').then(r => r.json()),
                fetch('/api/dataframes/stats').then(r => r.json())
            ]);

            // Handle dataframes response
            if (dataframesResponse.dataframes !== undefined) {
                dataframes = dataframesResponse.dataframes || [];
            } else {
                throw new Error('Invalid response format for DataFrames');
            }

            // Handle stats response - stats are returned directly, not nested under 'data'
            if (statsResponse.dataframe_count !== undefined) {
                updateStatistics(statsResponse);
            } else {
                throw new Error('Invalid response format for stats');
            }

            updateDataFramesTable();
            showToast('Dashboard refreshed successfully', 'success');
        } catch (error) {
            console.error('Error refreshing dashboard:', error);
            document.getElementById('dataframes-table-content').innerHTML =
                '<div class="empty-state">Error loading DataFrames. Please try again.</div>';
            showToast('Failed to refresh dashboard', 'error');
        }
    }

    function updateStatistics(stats) {
        document.getElementById('total-dataframes').textContent = stats.dataframe_count || 0;
        document.getElementById('total-memory').textContent = formatMemorySize(stats.total_memory_mb * 1024 * 1024 || 0);
        document.getElementById('expired-count').textContent = stats.expired_count || 0;
        document.getElementById('active-count').textContent = (stats.dataframe_count || 0) - (stats.expired_count || 0);

        // Update stat card styling based on values
        const expiredCard = document.getElementById('expired-count').closest('.stat-card');
        if (stats.expired_count > 0) {
            expiredCard.classList.add('warning');
        } else {
            expiredCard.classList.remove('warning');
        }
    }

    function updateDataFramesTable() {
        const container = document.getElementById('dataframes-table-content');

        if (!dataframes || dataframes.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">No DataFrames Found</div>
                <div class="empty-state-text">Upload a file or load data from a URL to get started.</div>
                <button class="btn btn-primary" onclick="showUploadModal()">Upload Your First File</button>
            </div>
        `;
            return;
        }

        // Apply current filter and sort
        filteredDataframes = filterAndSortDataframes();

        let html = `
        <table class="dataframes-table">
            <thead>
                <tr>
                    ${batchMode ? '<th><input type="checkbox" onchange="toggleSelectAll(this)"></th>' : ''}
                    <th class="sortable" onclick="sortBy('df_id')">ID ${getSortIcon('df_id')}</th>
                    <th class="sortable" onclick="sortBy('display_name')">Name ${getSortIcon('display_name')}</th>
                    <th class="sortable" onclick="sortBy('shape')">Shape ${getSortIcon('shape')}</th>
                    <th class="sortable" onclick="sortBy('memory_usage')">Memory ${getSortIcon('memory_usage')}</th>
                    <th class="sortable" onclick="sortBy('created_at')">Created ${getSortIcon('created_at')}</th>
                    <th class="sortable" onclick="sortBy('expires_at')">Status ${getSortIcon('expires_at')}</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

        filteredDataframes.forEach(df => {
            const statusBadge = getStatusBadge(df);
            const displayName = df.tags?.display_name || df.df_id;

            html += `
            <tr>
                ${batchMode ? `<td><input type="checkbox" onchange="toggleSelect('${df.df_id}')" ${selectedDataframes.has(df.df_id) ? 'checked' : ''}></td>` : ''}
                <td><code>${truncateText(df.df_id, 12)}</code></td>
                <td><strong>${truncateText(displayName, 20)}</strong></td>
                <td>${formatShape(df.shape)}</td>
                <td>${formatMemorySize(df.memory_usage)}</td>
                <td>${formatDate(df.created_at)}</td>
                <td><span class="status-badge ${statusBadge.class}">${statusBadge.text}</span></td>
                <td class="actions">
                    <a href="/dataframes/${df.df_id}" class="btn btn-primary">View</a>
                    <button class="btn btn-danger" onclick="deleteDataFrame('${df.df_id}')">Delete</button>
                </td>
            </tr>
        `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function filterAndSortDataframes() {
        let filtered = [...dataframes];

        // Apply search filter
        const searchTerm = document.getElementById('search-box').value.toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(df => {
                const displayName = df.tags?.display_name || df.df_id;
                return displayName.toLowerCase().includes(searchTerm) ||
                    df.df_id.toLowerCase().includes(searchTerm) ||
                    (df.tags?.source || '').toLowerCase().includes(searchTerm);
            });
        }

        // Apply sorting
        filtered.sort((a, b) => {
            let aVal = a[sortColumn];
            let bVal = b[sortColumn];

            // Special handling for different column types
            if (sortColumn === 'display_name') {
                aVal = a.tags?.display_name || a.df_id;
                bVal = b.tags?.display_name || b.df_id;
            } else if (sortColumn === 'shape') {
                aVal = a.shape ? a.shape[0] * a.shape[1] : 0;
                bVal = b.shape ? b.shape[0] * b.shape[1] : 0;
            } else if (sortColumn === 'created_at' || sortColumn === 'expires_at') {
                aVal = new Date(aVal || 0);
                bVal = new Date(bVal || 0);
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        return filtered;
    }

    function sortBy(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        updateDataFramesTable();
    }

    function getSortIcon(column) {
        if (sortColumn !== column) return '';
        return sortDirection === 'asc' ? '‚Üë' : '‚Üì';
    }

    function filterDataFrames() {
        updateDataFramesTable();
    }

    function toggleBatchMode() {
        batchMode = !batchMode;
        selectedDataframes.clear();
        document.getElementById('batch-mode-text').textContent = batchMode ? 'Exit Selection' : 'Select Multiple';
        updateDataFramesTable();
    }

    function toggleSelect(dfId) {
        if (selectedDataframes.has(dfId)) {
            selectedDataframes.delete(dfId);
        } else {
            selectedDataframes.add(dfId);
        }
        updateBatchControls();
    }

    function toggleSelectAll(checkbox) {
        if (checkbox.checked) {
            filteredDataframes.forEach(df => selectedDataframes.add(df.df_id));
        } else {
            selectedDataframes.clear();
        }
        updateDataFramesTable();
        updateBatchControls();
    }

    function updateBatchControls() {
        if (selectedDataframes.size > 0) {
            // Show batch operations button or modal
            document.getElementById('selected-count').textContent = selectedDataframes.size;
        }
    }

    // Modal functions
    function showUploadModal() {
        showModal('upload-modal');
        resetUploadForm();
    }

    function showUrlModal() {
        showModal('url-modal');
        resetUrlForm();
    }

    function resetUploadForm() {
        document.getElementById('file-input').value = '';
        document.getElementById('upload-display-name').value = '';
        document.getElementById('upload-format').value = 'auto';
        document.getElementById('upload-has-header').checked = true;
        document.getElementById('upload-progress').style.display = 'none';
        updateUploadPreview();
    }

    function resetUrlForm() {
        document.getElementById('url-input').value = '';
        document.getElementById('url-display-name').value = '';
        document.getElementById('url-format').value = 'auto';
        document.getElementById('url-has-header').checked = true;
        document.getElementById('url-progress').style.display = 'none';
    }

    function updateUploadPreview() {
        const files = document.getElementById('file-input').files;
        const uploadArea = document.getElementById('upload-area');

        if (files.length > 0) {
            const fileNames = Array.from(files).map(f => f.name).join(', ');
            uploadArea.innerHTML = `
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">
                <strong>${files.length} file(s) selected:</strong><br>
                ${truncateText(fileNames, 50)}
            </div>
            <div class="upload-hint">Click to select different files</div>
        `;
        } else {
            uploadArea.innerHTML = `
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">
                <strong>Click to select files</strong> or drag and drop here
            </div>
            <div class="upload-hint">
                Supported formats: CSV, JSON, Excel (.xlsx), Parquet
            </div>
        `;
        }
    }

    async function uploadFiles() {
        const files = document.getElementById('file-input').files;
        if (files.length === 0) {
            showToast('Please select at least one file', 'error');
            return;
        }

        const displayName = document.getElementById('upload-display-name').value.trim();
        const format = document.getElementById('upload-format').value;
        const hasHeader = document.getElementById('upload-has-header').checked;
        const uploadBtn = document.getElementById('upload-btn');
        const progressContainer = document.getElementById('upload-progress');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressText = document.getElementById('upload-progress-text');

        // Disable upload button and show progress
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        progressContainer.style.display = 'block';

        // Upload files one by one
        let successCount = 0;
        let errorCount = 0;
        const totalFiles = files.length;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const currentProgress = ((i + 1) / totalFiles) * 100;

            try {
                progressText.textContent = `Uploading ${file.name} (${i + 1}/${totalFiles})...`;
                progressBar.style.width = `${currentProgress}%`;

                // Validate file size (100MB limit)
                if (file.size > 100 * 1024 * 1024) {
                    throw new Error(`File ${file.name} is too large (max 100MB)`);
                }

                // Create form data
                const formData = new FormData();
                formData.append('file', file);

                if (displayName && totalFiles === 1) {
                    formData.append('display_name', displayName);
                }

                if (format !== 'auto') {
                    formData.append('format', format);
                }

                formData.append('has_header', hasHeader);

                // Upload file
                const response = await fetch('/api/dataframes/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    successCount++;
                    showToast(`Successfully uploaded ${file.name}`, 'success');
                } else {
                    errorCount++;
                    showToast(`Failed to upload ${file.name}: ${result.error}`, 'error');
                }

            } catch (error) {
                errorCount++;
                console.error(`Error uploading ${file.name}:`, error);
                showToast(`Failed to upload ${file.name}: ${error.message}`, 'error');
            }
        }

        // Show final status
        progressBar.style.width = '100%';
        if (successCount > 0) {
            progressText.textContent = `Completed: ${successCount} successful, ${errorCount} failed`;

            // Refresh dashboard after successful uploads
            setTimeout(() => {
                refreshDashboard();
                hideModal('upload-modal');
            }, 2000);
        } else {
            progressText.textContent = `Upload failed for all files`;

            // Hide modal after delay
            setTimeout(() => {
                hideModal('upload-modal');
            }, 3000);
        }

        // Re-enable upload button
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload';
    }

    async function loadFromUrl() {
        const url = document.getElementById('url-input').value.trim();
        if (!url) {
            showToast('Please enter a URL', 'error');
            return;
        }

        // Basic URL validation
        try {
            new URL(url);
        } catch (error) {
            showToast('Please enter a valid URL', 'error');
            return;
        }

        const displayName = document.getElementById('url-display-name').value.trim();
        const format = document.getElementById('url-format').value;
        const hasHeader = document.getElementById('url-has-header').checked;
        const loadBtn = document.getElementById('url-load-btn');
        const progressContainer = document.getElementById('url-progress');
        const progressBar = document.getElementById('url-progress-bar');
        const progressText = document.getElementById('url-progress-text');

        // Disable load button and show progress
        loadBtn.disabled = true;
        loadBtn.textContent = 'Loading...';
        progressContainer.style.display = 'block';
        progressText.textContent = 'Connecting to URL...';
        progressBar.style.width = '10%';

        try {
            // Prepare request data
            const requestData = {
                url: url,
                format: format,
                has_header: hasHeader
            };

            if (displayName) {
                requestData.display_name = displayName;
            }

            // Update progress
            progressText.textContent = 'Downloading data...';
            progressBar.style.width = '50%';

            // Make API request
            const response = await fetch('/api/dataframes/load-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            // Update progress
            progressText.textContent = 'Processing data...';
            progressBar.style.width = '80%';

            const result = await response.json();

            if (result.success) {
                progressBar.style.width = '100%';
                progressText.textContent = 'Data loaded successfully!';

                showToast(`Successfully loaded data from URL into DataFrame ${result.df_id}`, 'success');

                // Refresh dashboard and close modal after short delay
                setTimeout(() => {
                    refreshDashboard();
                    hideModal('url-modal');
                }, 1500);

            } else {
                throw new Error(result.error || 'Failed to load data from URL');
            }

        } catch (error) {
            console.error('Error loading from URL:', error);
            progressText.textContent = 'Load failed';
            progressBar.style.width = '0%';

            let errorMessage = error.message;
            if (error.message.includes('fetch')) {
                errorMessage = 'Network error: Could not connect to the URL';
            } else if (error.message.includes('JSON')) {
                errorMessage = 'Invalid server response';
            }

            showToast(`Failed to load data: ${errorMessage}`, 'error');

            // Hide modal after delay
            setTimeout(() => {
                hideModal('url-modal');
            }, 3000);
        } finally {
            // Re-enable load button
            loadBtn.disabled = false;
            loadBtn.textContent = 'Load Data';
        }
    }

    async function deleteDataFrame(dfId) {
        const df = dataframes.find(d => d.df_id === dfId);
        const displayName = df?.tags?.display_name || dfId;

        if (!confirm(`Are you sure you want to delete "${displayName}"? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/dataframes/${dfId}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                showToast('DataFrame deleted successfully', 'success');
                refreshDashboard();
            } else {
                throw new Error(result.error || 'Failed to delete DataFrame');
            }
        } catch (error) {
            showToast(`Failed to delete DataFrame: ${error.message}`, 'error');
        }
    }

    async function cleanupExpired() {
        if (!confirm('This will permanently delete all expired DataFrames. Continue?')) {
            return;
        }

        try {
            const response = await fetch('/api/dataframes/cleanup', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                const count = result.deleted_count || 0;
                const freedMemory = formatMemorySize(result.freed_memory_mb * 1024 * 1024 || 0);
                showToast(`Cleaned up ${count} DataFrame(s), freed ${freedMemory}`, 'success');
                refreshDashboard();
            } else {
                throw new Error(result.error || 'Cleanup failed');
            }
        } catch (error) {
            showToast(`Cleanup failed: ${error.message}`, 'error');
        }
    }

    // Utility functions
    function formatMemorySize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatShape(shape) {
        if (!shape || !Array.isArray(shape)) return 'Unknown';
        return `${shape[0]} √ó ${shape[1]}`;
    }

    function formatDate(dateString) {
        if (!dateString) return 'Unknown';
        return new Date(dateString).toLocaleDateString();
    }

    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    function getStatusBadge(df) {
        if (!df.expires_at) {
            return { class: 'active', text: 'Active' };
        }

        const now = new Date();
        const expiresAt = new Date(df.expires_at);

        if (expiresAt <= now) {
            return { class: 'expired', text: 'Expired' };
        }

        const hoursUntilExpiry = (expiresAt - now) / (1000 * 60 * 60);
        if (hoursUntilExpiry < 24) {
            return { class: 'warning', text: 'Expiring Soon' };
        }

        return { class: 'active', text: 'Active' };
    }

    function showLoading(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `<div style="text-align: center; padding: 2em; color: #666;">${message}</div>`;
        }
    }

    function showToast(message, type = 'info') {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1em;
            border-radius: 4px;
            color: white;
            z-index: 10000;
            max-width: 300px;
        `;

        switch (type) {
            case 'success':
                toast.style.backgroundColor = '#28a745';
                break;
            case 'error':
                toast.style.backgroundColor = '#dc3545';
                break;
            case 'warning':
                toast.style.backgroundColor = '#ffc107';
                toast.style.color = '#212529';
                break;
            default:
                toast.style.backgroundColor = '#0077cc';
        }

        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}
