{% extends "base.html" %}

{% block title %}DataFrames - MCP Knowledge Server{% endblock %}

{% block extra_styles %}
<style>
    /* DataFrame Dashboard Styles */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2em;
        flex-wrap: wrap;
        gap: 1em;
    }

    .dashboard-title {
        margin: 0;
        color: #333;
    }

    .dashboard-actions {
        display: flex;
        gap: 0.5em;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.5em 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5em;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: #0077cc;
        color: white;
    }

    .btn-primary:hover {
        background: #005fa3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    /* Statistics Cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1em;
        margin-bottom: 2em;
    }

    .stat-card {
        background: #fff;
        padding: 1.5em;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-left: 4px solid #0077cc;
    }

    .stat-card.warning {
        border-left-color: #ffc107;
    }

    .stat-card.danger {
        border-left-color: #dc3545;
    }

    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin: 0;
    }

    .stat-label {
        color: #666;
        margin: 0.5em 0 0 0;
        font-size: 0.9em;
    }

    /* DataFrame Table */
    .dataframes-table-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table-header {
        background: #f8f9fa;
        padding: 1em;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1em;
    }

    .table-title {
        margin: 0;
        color: #333;
        font-size: 1.1em;
    }

    .table-controls {
        display: flex;
        gap: 0.5em;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-input {
        padding: 0.4em 0.8em;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9em;
        min-width: 200px;
    }

    .dataframes-table {
        width: 100%;
        border-collapse: collapse;
    }

    .dataframes-table th,
    .dataframes-table td {
        padding: 0.75em;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .dataframes-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #333;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .dataframes-table th:hover {
        background: #e9ecef;
    }

    .sort-indicator {
        position: absolute;
        right: 0.5em;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.5;
        font-size: 0.8em;
    }

    .sort-indicator.active {
        opacity: 1;
        color: #0077cc;
    }

    .dataframes-table tr:hover {
        background: #f8f9fa;
    }

    .dataframe-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .dataframe-row:hover {
        background: #f0f8ff !important;
    }

    /* Status indicators */
    .status-badge {
        padding: 0.25em 0.5em;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-expired {
        background: #f8d7da;
        color: #721c24;
    }

    .status-warning {
        background: #fff3cd;
        color: #856404;
    }

    /* Memory usage bars */
    .memory-bar {
        width: 100px;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .memory-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        transition: width 0.3s ease;
    }

    /* Action buttons in table */
    .action-buttons {
        display: flex;
        gap: 0.25em;
    }

    .btn-sm {
        padding: 0.25em 0.5em;
        font-size: 0.8em;
        border-radius: 3px;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 3em;
        color: #666;
    }

    .empty-state-icon {
        font-size: 3em;
        margin-bottom: 0.5em;
        opacity: 0.5;
    }

    /* Loading state */
    .loading {
        text-align: center;
        padding: 2em;
        color: #666;
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0077cc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5em;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: stretch;
        }

        .dashboard-actions {
            justify-content: center;
        }

        .stats-container {
            grid-template-columns: 1fr;
        }

        .table-header {
            flex-direction: column;
            align-items: stretch;
        }

        .table-controls {
            justify-content: center;
        }

        .search-input {
            min-width: auto;
            width: 100%;
        }

        .dataframes-table {
            font-size: 0.9em;
        }

        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h2 class="dashboard-title">DataFrames Dashboard</h2>
        <div class="dashboard-actions">
            <button class="btn btn-success" onclick="showLoadDataModal()">
                üìÅ Load Data
            </button>
            <button class="btn btn-warning" onclick="cleanupExpired()">
                üßπ Cleanup Expired
            </button>
            <button class="btn btn-secondary" onclick="refreshDashboard()">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Storage Statistics -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value" id="total-dataframes">-</div>
            <div class="stat-label">Total DataFrames</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-memory">-</div>
            <div class="stat-label">Memory Usage (MB)</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="expired-count">-</div>
            <div class="stat-label">Expired DataFrames</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avg-size">-</div>
            <div class="stat-label">Average Size (MB)</div>
        </div>
    </div>

    <!-- DataFrames Table -->
    <div class="dataframes-table-container">
        <div class="table-header">
            <h3 class="table-title">DataFrames</h3>
            <div class="table-controls">
                <input type="text" class="search-input" id="search-input" placeholder="Search DataFrames..."
                    onkeyup="filterDataFrames()">
                <select class="btn btn-secondary" id="status-filter" onchange="filterDataFrames()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="warning">Expiring Soon</option>
                </select>
            </div>
        </div>

        <div id="loading-indicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            Loading DataFrames...
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üìä</div>
            <h3>No DataFrames Found</h3>
            <p>Get started by loading your first dataset!</p>
            <button class="btn btn-primary" onclick="showLoadDataModal()">Load Data</button>
        </div>

        <table class="dataframes-table" id="dataframes-table" style="display: none;">
            <thead>
                <tr>
                    <th onclick="sortTable('df_id')">
                        ID
                        <span class="sort-indicator" id="sort-df_id">‚Üï</span>
                    </th>
                    <th onclick="sortTable('created_at')">
                        Created
                        <span class="sort-indicator" id="sort-created_at">‚Üï</span>
                    </th>
                    <th onclick="sortTable('shape')">
                        Shape (Rows √ó Cols)
                        <span class="sort-indicator" id="sort-shape">‚Üï</span>
                    </th>
                    <th onclick="sortTable('memory_usage')">
                        Memory Usage
                        <span class="sort-indicator" id="sort-memory_usage">‚Üï</span>
                    </th>
                    <th onclick="sortTable('status')">
                        Status
                        <span class="sort-indicator" id="sort-status">‚Üï</span>
                    </th>
                    <th onclick="sortTable('source')">
                        Source
                        <span class="sort-indicator" id="sort-source">‚Üï</span>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="dataframes-table-body">
            </tbody>
        </table>
    </div>
</div>

<!-- Load Data Modal -->
<div id="load-data-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Load New Data</h3>

        <div style="margin-bottom: 2em;">
            <label>
                <input type="radio" name="load-method" value="file" checked onchange="toggleLoadMethod()">
                Upload File
            </label>
            <label style="margin-left: 2em;">
                <input type="radio" name="load-method" value="url" onchange="toggleLoadMethod()">
                Load from URL
            </label>
        </div>

        <!-- File Upload Section -->
        <div id="file-upload-section">
            <!-- Drag and Drop Area -->
            <div id="drop-zone" style="
                border: 2px dashed #ddd;
                border-radius: 8px;
                padding: 2em;
                text-align: center;
                margin-bottom: 1em;
                background: #f8f9fa;
                cursor: pointer;
                transition: all 0.3s ease;
            " onclick="document.getElementById('file-input').click()">
                <div style="font-size: 2em; margin-bottom: 0.5em; opacity: 0.5;">üìÅ</div>
                <div style="font-weight: bold; margin-bottom: 0.5em;">Drop files here or click to browse</div>
                <div style="font-size: 0.9em; color: #666;">
                    Supported formats: CSV, JSON, Excel (.xlsx, .xls), Parquet
                </div>
                <div style="font-size: 0.8em; color: #999; margin-top: 0.5em;">
                    Maximum file size: 100MB
                </div>
            </div>

            <input type="file" id="file-input" accept=".csv,.json,.xlsx,.xls,.parquet" style="display: none;" multiple>

            <!-- Selected Files Display -->
            <div id="selected-files" style="margin-bottom: 1em; display: none;">
                <label>Selected Files:</label>
                <div id="file-list" style="margin-top: 0.5em;"></div>
            </div>

            <!-- Upload Progress -->
            <div id="upload-progress" style="margin-bottom: 1em; display: none;">
                <div class="progress-container">
                    <div class="progress-bar" id="upload-progress-bar"></div>
                </div>
                <div class="progress-text" id="upload-progress-text">Preparing upload...</div>
            </div>

            <div style="margin-bottom: 1em;">
                <label for="file-format">Format:</label>
                <select id="file-format" style="width: 100%; margin-top: 0.5em;">
                    <option value="auto">Auto-detect</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                    <option value="parquet">Parquet</option>
                </select>
            </div>

            <!-- Advanced Options -->
            <details style="margin-bottom: 1em;">
                <summary style="cursor: pointer; font-weight: bold;">Advanced Options</summary>
                <div style="margin-top: 1em; padding: 1em; background: #f8f9fa; border-radius: 4px;">
                    <div style="margin-bottom: 0.5em;">
                        <label>
                            <input type="checkbox" id="has-header" checked>
                            First row contains headers
                        </label>
                    </div>
                    <div style="margin-bottom: 0.5em;">
                        <label for="encoding">Text Encoding:</label>
                        <select id="encoding" style="width: 100%; margin-top: 0.25em;">
                            <option value="utf-8">UTF-8</option>
                            <option value="latin-1">Latin-1</option>
                            <option value="cp1252">Windows-1252</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0.5em;">
                        <label for="separator">CSV Separator:</label>
                        <select id="separator" style="width: 100%; margin-top: 0.25em;">
                            <option value="auto">Auto-detect</option>
                            <option value=",">Comma (,)</option>
                            <option value=";">Semicolon (;)</option>
                            <option value="\t">Tab</option>
                            <option value="|">Pipe (|)</option>
                        </select>
                    </div>
                </div>
            </details>
        </div>

        <!-- URL Loading Section -->
        <div id="url-load-section" style="display: none;">
            <div style="margin-bottom: 1em;">
                <label for="data-url">Data URL:</label>
                <input type="url" id="data-url" placeholder="https://example.com/data.csv"
                    style="width: 100%; margin-top: 0.5em;">
            </div>

            <div style="margin-bottom: 1em;">
                <label for="url-format">Format:</label>
                <select id="url-format" style="width: 100%; margin-top: 0.5em;">
                    <option value="auto">Auto-detect</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                    <option value="parquet">Parquet</option>
                </select>
            </div>
        </div>

        <!-- Common Options -->
        <div style="margin-bottom: 1em;">
            <label for="display-name">Display Name (optional):</label>
            <input type="text" id="display-name" placeholder="My Dataset" style="width: 100%; margin-top: 0.5em;">
        </div>

        <div style="margin-bottom: 2em;">
            <label>
                <input type="checkbox" id="has-header" checked>
                First row contains headers
            </label>
        </div>

        <div style="text-align: right;">
            <button class="btn btn-secondary" onclick="hideModal('load-data-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="loadData()" style="margin-left: 0.5em;">Load Data</button>
        </div>

        <div id="load-status" style="margin-top: 1em; display: none;"></div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="confirm-title">Confirm Action</h3>
        <p id="confirm-message">Are you sure you want to proceed?</p>
        <div style="text-align: right; margin-top: 2em;">
            <button class="btn btn-secondary" onclick="hideModal('confirm-modal')">Cancel</button>
            <button class="btn btn-danger" id="confirm-button" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables
    let dataframes = [];
    let filteredDataframes = [];
    let sortColumn = 'created_at';
    let sortDirection = 'desc';
    let pendingAction = null;
    let autoRefreshInterval = null;
    let autoRefreshEnabled = false;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        loadDataFrames();
        setupAutoRefresh();
    });

    // Load DataFrames from API using the new API client
    async function loadDataFrames() {
        showLoading(true);
        try {
            const data = await dataframeAPI.getDataFrames();

            dataframes = data.dataframes || [];
            updateStatistics(data.storage_stats || {});
            filteredDataframes = [...dataframes];
            sortDataFrames();
            renderDataFrames();

            DataFrameUI.showToast('DataFrames loaded successfully', 'success', 2000);
        } catch (error) {
            console.error('Error loading DataFrames:', error);
            DataFrameUI.showToast('Error loading DataFrames: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    // Setup auto-refresh functionality
    function setupAutoRefresh() {
        // Add auto-refresh toggle to dashboard actions
        const dashboardActions = document.querySelector('.dashboard-actions');
        const autoRefreshBtn = document.createElement('button');
        autoRefreshBtn.className = 'btn btn-secondary';
        autoRefreshBtn.id = 'auto-refresh-btn';
        autoRefreshBtn.innerHTML = '‚è∏Ô∏è Auto-refresh: OFF';
        autoRefreshBtn.onclick = toggleAutoRefresh;
        dashboardActions.appendChild(autoRefreshBtn);
    }

    function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const btn = document.getElementById('auto-refresh-btn');

        if (autoRefreshEnabled) {
            btn.innerHTML = '‚è∏Ô∏è Auto-refresh: ON';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');
            startAutoRefresh();
        } else {
            btn.innerHTML = '‚ñ∂Ô∏è Auto-refresh: OFF';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            stopAutoRefresh();
        }
    }

    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }

        autoRefreshInterval = setInterval(() => {
            if (autoRefreshEnabled && !dataframeAPI.isLoading()) {
                loadDataFrames();
            }
        }, 30000); // Refresh every 30 seconds
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // Update statistics display with enhanced formatting
    function updateStatistics(stats) {
        document.getElementById('total-dataframes').textContent = DataFrameFormatter.formatNumber(stats.total_dataframes || 0);
        document.getElementById('total-memory').textContent = (stats.total_memory_mb || 0).toFixed(1);
        document.getElementById('expired-count').textContent = DataFrameFormatter.formatNumber(stats.expired_count || 0);

        const avgSize = stats.total_dataframes > 0 ?
            (stats.total_memory_mb / stats.total_dataframes) : 0;
        document.getElementById('avg-size').textContent = avgSize.toFixed(1);

        // Update stat card styling based on values
        const expiredCard = document.querySelector('.stat-card.warning');
        if (stats.expired_count > 0) {
            expiredCard.classList.add('danger');
            expiredCard.classList.remove('warning');
        } else {
            expiredCard.classList.add('warning');
            expiredCard.classList.remove('danger');
        }
    }

    // Show/hide loading indicator
    function showLoading(show) {
        document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
        document.getElementById('dataframes-table').style.display = show ? 'none' : (filteredDataframes.length > 0 ? 'table' : 'none');
        document.getElementById('empty-state').style.display = show ? 'none' : (filteredDataframes.length === 0 ? 'block' : 'none');
    }

    // Render DataFrames table
    function renderDataFrames() {
        const tbody = document.getElementById('dataframes-table-body');
        tbody.innerHTML = '';

        if (filteredDataframes.length === 0) {
            document.getElementById('dataframes-table').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            return;
        }

        document.getElementById('dataframes-table').style.display = 'table';
        document.getElementById('empty-state').style.display = 'none';

        filteredDataframes.forEach(df => {
            const row = document.createElement('tr');
            row.className = 'dataframe-row';
            row.onclick = () => viewDataFrame(df.df_id);

            const status = getDataFrameStatus(df);
            const memoryMB = (df.memory_usage / (1024 * 1024)).toFixed(1);
            const createdDate = new Date(df.created_at).toLocaleDateString();
            const source = df.source ? df.source.substring(0, 30) + (df.source.length > 30 ? '...' : '') : 'Unknown';

            row.innerHTML = `
                <td><strong>${df.df_id}</strong></td>
                <td>${createdDate}</td>
                <td>${df.shape[0].toLocaleString()} √ó ${df.shape[1]}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        ${memoryMB} MB
                        <div class="memory-bar">
                            <div class="memory-fill" style="width: ${Math.min(100, (df.memory_usage / (100 * 1024 * 1024)) * 100)}%"></div>
                        </div>
                    </div>
                </td>
                <td><span class="status-badge status-${status.class}">${status.text}</span></td>
                <td title="${df.source || 'Unknown'}">${source}</td>
                <td onclick="event.stopPropagation()">
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="viewDataFrame('${df.df_id}')">View</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDataFrame('${df.df_id}')">Delete</button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    // Get DataFrame status
    function getDataFrameStatus(df) {
        if (df.is_expired) {
            return { class: 'expired', text: 'Expired' };
        }

        if (df.expires_at) {
            const expiresAt = new Date(df.expires_at);
            const now = new Date();
            const hoursUntilExpiry = (expiresAt - now) / (1000 * 60 * 60);

            if (hoursUntilExpiry < 24) {
                return { class: 'warning', text: 'Expiring Soon' };
            }
        }

        return { class: 'active', text: 'Active' };
    }

    // Sort DataFrames
    function sortTable(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }

        updateSortIndicators();
        sortDataFrames();
        renderDataFrames();
    }

    function sortDataFrames() {
        filteredDataframes.sort((a, b) => {
            let aVal, bVal;

            switch (sortColumn) {
                case 'df_id':
                    aVal = a.df_id;
                    bVal = b.df_id;
                    break;
                case 'created_at':
                    aVal = new Date(a.created_at);
                    bVal = new Date(b.created_at);
                    break;
                case 'shape':
                    aVal = a.shape[0] * a.shape[1];
                    bVal = b.shape[0] * b.shape[1];
                    break;
                case 'memory_usage':
                    aVal = a.memory_usage;
                    bVal = b.memory_usage;
                    break;
                case 'status':
                    aVal = getDataFrameStatus(a).text;
                    bVal = getDataFrameStatus(b).text;
                    break;
                case 'source':
                    aVal = a.source || '';
                    bVal = b.source || '';
                    break;
                default:
                    return 0;
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function updateSortIndicators() {
        // Reset all indicators
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.textContent = '‚Üï';
            indicator.classList.remove('active');
        });

        // Set active indicator
        const activeIndicator = document.getElementById(`sort-${sortColumn}`);
        if (activeIndicator) {
            activeIndicator.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
            activeIndicator.classList.add('active');
        }
    }

    // Filter DataFrames
    function filterDataFrames() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        filteredDataframes = dataframes.filter(df => {
            // Text search
            const matchesSearch = !searchTerm ||
                df.df_id.toLowerCase().includes(searchTerm) ||
                (df.source && df.source.toLowerCase().includes(searchTerm)) ||
                (df.tags && df.tags.display_name && df.tags.display_name.toLowerCase().includes(searchTerm));

            // Status filter
            const status = getDataFrameStatus(df);
            const matchesStatus = !statusFilter || status.class === statusFilter;

            return matchesSearch && matchesStatus;
        });

        sortDataFrames();
        renderDataFrames();
    }

    // Navigation functions
    function viewDataFrame(dfId) {
        window.location.href = `/dataframes/${dfId}`;
    }

    function refreshDashboard() {
        loadDataFrames();
    }

    // Load data modal functions
    function showLoadDataModal() {
        showModal('load-data-modal');
        setupDragAndDrop();
    }

    function toggleLoadMethod() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        document.getElementById('file-upload-section').style.display = method === 'file' ? 'block' : 'none';
        document.getElementById('url-load-section').style.display = method === 'url' ? 'block' : 'none';
    }

    // Enhanced drag-and-drop functionality
    function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        if (!dropZone || !fileInput) return;

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);

        // Handle file input change
        fileInput.addEventListener('change', handleFileSelect, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropZone.style.borderColor = '#0077cc';
            dropZone.style.backgroundColor = '#f0f8ff';
            dropZone.style.transform = 'scale(1.02)';
        }

        function unhighlight(e) {
            dropZone.style.borderColor = '#ddd';
            dropZone.style.backgroundColor = '#f8f9fa';
            dropZone.style.transform = 'scale(1)';
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            // Validate files
            const validFiles = [];
            const errors = [];

            Array.from(files).forEach(file => {
                const validation = validateFile(file);
                if (validation.valid) {
                    validFiles.push(file);
                } else {
                    errors.push(`${file.name}: ${validation.error}`);
                }
            });

            if (errors.length > 0) {
                DataFrameUI.showToast('File validation errors:\n' + errors.join('\n'), 'error', 5000);
            }

            if (validFiles.length > 0) {
                displaySelectedFiles(validFiles);
                // Auto-detect format from first file
                autoDetectFormat(validFiles[0]);
            }
        }
    }

    // File validation
    function validateFile(file) {
        const maxSize = 100 * 1024 * 1024; // 100MB
        const allowedTypes = [
            'text/csv',
            'application/json',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-excel',
            'application/octet-stream' // For parquet files
        ];
        const allowedExtensions = ['.csv', '.json', '.xlsx', '.xls', '.parquet'];

        // Check file size
        if (file.size > maxSize) {
            return {
                valid: false,
                error: `File too large (${DataFrameFormatter.formatMemorySize(file.size)}). Maximum size is 100MB.`
            };
        }

        // Check file extension
        const extension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(extension)) {
            return {
                valid: false,
                error: `Unsupported file type. Allowed types: ${allowedExtensions.join(', ')}`
            };
        }

        return { valid: true };
    }

    // Display selected files
    function displaySelectedFiles(files) {
        const selectedFilesDiv = document.getElementById('selected-files');
        const fileListDiv = document.getElementById('file-list');

        if (files.length === 0) {
            selectedFilesDiv.style.display = 'none';
            return;
        }

        selectedFilesDiv.style.display = 'block';
        fileListDiv.innerHTML = '';

        Array.from(files).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5em;
                background: #f8f9fa;
                border-radius: 4px;
                margin-bottom: 0.5em;
            `;

            fileItem.innerHTML = `
                <div>
                    <strong>${file.name}</strong>
                    <span style="color: #666; margin-left: 1em;">
                        ${DataFrameFormatter.formatMemorySize(file.size)}
                    </span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="removeFile(${index})" type="button">
                    Remove
                </button>
            `;

            fileListDiv.appendChild(fileItem);
        });
    }

    // Remove file from selection
    function removeFile(index) {
        const fileInput = document.getElementById('file-input');
        const dt = new DataTransfer();

        Array.from(fileInput.files).forEach((file, i) => {
            if (i !== index) {
                dt.items.add(file);
            }
        });

        fileInput.files = dt.files;
        displaySelectedFiles(fileInput.files);
    }

    // Auto-detect file format
    function autoDetectFormat(file) {
        const extension = '.' + file.name.split('.').pop().toLowerCase();
        const formatSelect = document.getElementById('file-format');

        const formatMap = {
            '.csv': 'csv',
            '.json': 'json',
            '.xlsx': 'excel',
            '.xls': 'excel',
            '.parquet': 'parquet'
        };

        if (formatMap[extension]) {
            formatSelect.value = formatMap[extension];
        }
    }

    // Enhanced URL validation
    function validateUrl(url) {
        try {
            const urlObj = new URL(url);

            // Check protocol
            if (!['http:', 'https:'].includes(urlObj.protocol)) {
                return { valid: false, error: 'Only HTTP and HTTPS URLs are supported' };
            }

            // Check for common data file extensions
            const pathname = urlObj.pathname.toLowerCase();
            const supportedExtensions = ['.csv', '.json', '.xlsx', '.xls', '.parquet'];
            const hasValidExtension = supportedExtensions.some(ext => pathname.endsWith(ext));

            if (!hasValidExtension) {
                return {
                    valid: true,
                    warning: 'URL does not end with a recognized data file extension. Auto-detection may not work correctly.'
                };
            }

            return { valid: true };
        } catch (error) {
            return { valid: false, error: 'Invalid URL format' };
        }
    }

    // Enhanced load data function with progress tracking
    async function loadData() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        const displayName = document.getElementById('display-name').value;
        const hasHeader = document.getElementById('has-header').checked;

        clearStatus('load-status');

        try {
            let data;

            if (method === 'file') {
                const fileInput = document.getElementById('file-input');
                const format = document.getElementById('file-format').value;

                if (!fileInput.files || fileInput.files.length === 0) {
                    showStatus('load-status', 'Please select a file', true);
                    return;
                }

                // Show upload progress
                showUploadProgress(true);

                // Get advanced options
                const encoding = document.getElementById('encoding').value;
                const separator = document.getElementById('separator').value;

                // Process each file (for now, just the first one)
                const file = fileInput.files[0];

                data = await dataframeAPI.uploadFile(file, {
                    format: format === 'auto' ? null : format,
                    displayName: displayName || file.name.split('.')[0],
                    hasHeader,
                    encoding: encoding !== 'utf-8' ? encoding : undefined,
                    separator: separator !== 'auto' ? separator : undefined
                });

            } else {
                const url = document.getElementById('data-url').value.trim();
                const format = document.getElementById('url-format').value;

                if (!url) {
                    showStatus('load-status', 'Please enter a URL', true);
                    return;
                }

                // Validate URL
                const urlValidation = validateUrl(url);
                if (!urlValidation.valid) {
                    showStatus('load-status', urlValidation.error, true);
                    return;
                }

                if (urlValidation.warning) {
                    DataFrameUI.showToast(urlValidation.warning, 'warning', 4000);
                }

                data = await dataframeAPI.loadFromUrl(url, {
                    format: format === 'auto' ? null : format,
                    displayName: displayName || 'URL Dataset',
                    hasHeader
                });
            }

            showStatus('load-status', 'Data loaded successfully!', false);
            DataFrameUI.showToast('Data loaded successfully!', 'success');

            setTimeout(() => {
                hideModal('load-data-modal');
                resetLoadDataForm();
                loadDataFrames();
            }, 1500);

        } catch (error) {
            console.error('Error loading data:', error);
            showStatus('load-status', 'Error: ' + error.message, true);
            DataFrameUI.showToast('Error loading data: ' + error.message, 'error');
        } finally {
            showUploadProgress(false);
        }
    }

    // Show/hide upload progress
    function showUploadProgress(show) {
        const progressDiv = document.getElementById('upload-progress');
        if (progressDiv) {
            progressDiv.style.display = show ? 'block' : 'none';
        }
    }

    // Reset load data form
    function resetLoadDataForm() {
        document.getElementById('file-input').value = '';
        document.getElementById('data-url').value = '';
        document.getElementById('display-name').value = '';
        document.getElementById('has-header').checked = true;
        document.getElementById('file-format').value = 'auto';
        document.getElementById('url-format').value = 'auto';
        document.getElementById('encoding').value = 'utf-8';
        document.getElementById('separator').value = 'auto';
        document.getElementById('selected-files').style.display = 'none';
        document.getElementById('upload-progress').style.display = 'none';

        // Reset load method to file
        document.querySelector('input[name="load-method"][value="file"]').checked = true;
        toggleLoadMethod();
    }

    async function loadData() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        const displayName = document.getElementById('display-name').value;
        const hasHeader = document.getElementById('has-header').checked;

        clearStatus('load-status');

        try {
            let data;

            if (method === 'file') {
                const fileInput = document.getElementById('file-input');
                const format = document.getElementById('file-format').value;

                if (!fileInput.files[0]) {
                    showStatus('load-status', 'Please select a file', true);
                    return;
                }

                // Show progress indicator
                const progressContainer = document.createElement('div');
                progressContainer.innerHTML = `
                    <div class="progress-container" data-progress-id="upload_${fileInput.files[0].name}">
                        <div class="progress-bar"></div>
                        <div class="progress-text">Preparing upload...</div>
                    </div>
                `;
                document.getElementById('load-status').appendChild(progressContainer);
                document.getElementById('load-status').style.display = 'block';

                data = await dataframeAPI.uploadFile(fileInput.files[0], {
                    format: format === 'auto' ? null : format,
                    displayName,
                    hasHeader
                });
            } else {
                const url = document.getElementById('data-url').value;
                const format = document.getElementById('url-format').value;

                if (!url) {
                    showStatus('load-status', 'Please enter a URL', true);
                    return;
                }

                data = await dataframeAPI.loadFromUrl(url, {
                    format: format === 'auto' ? null : format,
                    displayName,
                    hasHeader
                });
            }

            showStatus('load-status', 'Data loaded successfully!', false);
            DataFrameUI.showToast('Data loaded successfully!', 'success');

            setTimeout(() => {
                hideModal('load-data-modal');
                loadDataFrames();
                // Reset form
                document.getElementById('file-input').value = '';
                document.getElementById('data-url').value = '';
                document.getElementById('display-name').value = '';
                document.getElementById('has-header').checked = true;
            }, 1500);

        } catch (error) {
            console.error('Error loading data:', error);
            showStatus('load-status', 'Error: ' + error.message, true);
            DataFrameUI.showToast('Error loading data: ' + error.message, 'error');
        }
    }

    // Delete DataFrame using new API client
    function deleteDataFrame(dfId) {
        DataFrameUI.confirm(
            'Delete DataFrame',
            `Are you sure you want to delete DataFrame "${dfId}"? This action cannot be undone.`,
            () => performDelete(dfId)
        );
    }

    async function performDelete(dfId) {
        try {
            await dataframeAPI.deleteDataFrame(dfId);
            DataFrameUI.showToast('DataFrame deleted successfully', 'success');
            loadDataFrames();
        } catch (error) {
            console.error('Error deleting DataFrame:', error);
            DataFrameUI.showToast('Error deleting DataFrame: ' + error.message, 'error');
        }
    }

    // Cleanup expired DataFrames using new API client
    function cleanupExpired() {
        DataFrameUI.confirm(
            'Cleanup Expired DataFrames',
            'Are you sure you want to delete all expired DataFrames? This action cannot be undone.',
            performCleanup
        );
    }

    async function performCleanup() {
        try {
            const data = await dataframeAPI.cleanupExpired();
            const message = `Cleanup completed. Removed ${data.removed_count} DataFrames, freed ${data.memory_freed_mb.toFixed(1)} MB.`;
            DataFrameUI.showToast(message, 'success', 5000);
            loadDataFrames();
        } catch (error) {
            console.error('Error during cleanup:', error);
            DataFrameUI.showToast('Error during cleanup: ' + error.message, 'error');
        }
    }

    // Confirmation modal (legacy support)
    function confirmAction() {
        if (pendingAction) {
            pendingAction();
            pendingAction = null;
        }
        hideModal('confirm-modal');
    }

    // Enhanced client-side filtering with debouncing
    let filterTimeout;
    function filterDataFrames() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            performFiltering();
        }, 300); // Debounce for 300ms
    }

    function performFiltering() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        filteredDataframes = dataframes.filter(df => {
            // Enhanced text search - search in multiple fields
            const searchFields = [
                df.df_id,
                df.source || '',
                (df.tags && df.tags.display_name) || '',
                DataFrameFormatter.formatShape(df.shape),
                DataFrameFormatter.formatMemorySize(df.memory_usage)
            ].join(' ').toLowerCase();

            const matchesSearch = !searchTerm || searchFields.includes(searchTerm);

            // Status filter
            const status = DataFrameFormatter.getStatusBadge(df);
            const matchesStatus = !statusFilter || status.class === statusFilter;

            return matchesSearch && matchesStatus;
        });

        sortDataFrames();
        renderDataFrames();

        // Update search results count
        updateSearchResultsCount();
    }

    function updateSearchResultsCount() {
        const tableTitle = document.querySelector('.table-title');
        const totalCount = dataframes.length;
        const filteredCount = filteredDataframes.length;

        if (filteredCount === totalCount) {
            tableTitle.textContent = `DataFrames (${totalCount})`;
        } else {
            tableTitle.textContent = `DataFrames (${filteredCount} of ${totalCount})`;
        }
    }

    // Enhanced rendering with better performance for large datasets
    function renderDataFrames() {
        const tbody = document.getElementById('dataframes-table-body');

        if (filteredDataframes.length === 0) {
            document.getElementById('dataframes-table').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            return;
        }

        document.getElementById('dataframes-table').style.display = 'table';
        document.getElementById('empty-state').style.display = 'none';

        // Use document fragment for better performance
        const fragment = document.createDocumentFragment();

        filteredDataframes.forEach(df => {
            const row = document.createElement('tr');
            row.className = 'dataframe-row';
            row.onclick = () => viewDataFrame(df.df_id);

            const status = DataFrameFormatter.getStatusBadge(df);
            const memoryFormatted = DataFrameFormatter.formatMemorySize(df.memory_usage);
            const createdDate = DataFrameFormatter.formatDate(df.created_at);
            const source = DataFrameFormatter.truncateText(df.source || 'Unknown', 30);
            const shape = DataFrameFormatter.formatShape(df.shape);

            // Calculate memory bar percentage (max 100MB = 100%)
            const memoryPercentage = Math.min(100, (df.memory_usage / (100 * 1024 * 1024)) * 100);

            row.innerHTML = `
                <td><strong>${df.df_id}</strong></td>
                <td>${createdDate}</td>
                <td>${shape}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        ${memoryFormatted}
                        <div class="memory-bar">
                            <div class="memory-fill" style="width: ${memoryPercentage}%"></div>
                        </div>
                    </div>
                </td>
                <td><span class="status-badge status-${status.class}">${status.text}</span></td>
                <td title="${df.source || 'Unknown'}">${source}</td>
                <td onclick="event.stopPropagation()">
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="viewDataFrame('${df.df_id}')">View</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDataFrame('${df.df_id}')">Delete</button>
                    </div>
                </td>
            `;

            fragment.appendChild(row);
        });

        // Clear and append all at once for better performance
        tbody.innerHTML = '';
        tbody.appendChild(fragment);

        updateSearchResultsCount();
    }

    // Enhanced sorting with better data type handling
    function sortDataFrames() {
        filteredDataframes.sort((a, b) => {
            let aVal, bVal;

            switch (sortColumn) {
                case 'df_id':
                    aVal = a.df_id.toLowerCase();
                    bVal = b.df_id.toLowerCase();
                    break;
                case 'created_at':
                    aVal = new Date(a.created_at);
                    bVal = new Date(b.created_at);
                    break;
                case 'shape':
                    aVal = a.shape[0] * a.shape[1];
                    bVal = b.shape[0] * b.shape[1];
                    break;
                case 'memory_usage':
                    aVal = a.memory_usage;
                    bVal = b.memory_usage;
                    break;
                case 'status':
                    // Sort by status priority: active < warning < expired
                    const statusPriority = { 'active': 0, 'warning': 1, 'expired': 2 };
                    aVal = statusPriority[DataFrameFormatter.getStatusBadge(a).class] || 0;
                    bVal = statusPriority[DataFrameFormatter.getStatusBadge(b).class] || 0;
                    break;
                case 'source':
                    aVal = (a.source || '').toLowerCase();
                    bVal = (b.source || '').toLowerCase();
                    break;
                default:
                    return 0;
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (event) {
        // Ctrl/Cmd + R: Refresh
        if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
            event.preventDefault();
            refreshDashboard();
        }

        // Ctrl/Cmd + L: Load data
        if ((event.ctrlKey || event.metaKey) && event.key === 'l') {
            event.preventDefault();
            showLoadDataModal();
        }

        // Escape: Close modals
        if (event.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.style.display === 'block') {
                    hideModal(modal.id);
                }
            });
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function () {
        stopAutoRefresh();
    });
</script>
{% endblock %}e, 'error');
}
}

// Confirmation modal (legacy support)
function confirmAction() {
if (pendingAction) {
pendingAction();
pendingAction = null;
}
hideModal('confirm-modal');
}

// Enhanced client-side filtering with debouncing
let filterTimeout;
function filterDataFrames() {
clearTimeout(filterTimeout);
filterTimeout = setTimeout(() => {
performFiltering();
}, 300); // Debounce for 300ms
}

function performFiltering() {
const searchTerm = document.getElementById('search-input').value.toLowerCase();
const statusFilter = document.getElementById('status-filter').value;

filteredDataframes = dataframes.filter(df => {
// Enhanced text search - search in multiple fields
const searchFields = [
df.df_id,
df.source || '',
(df.tags && df.tags.display_name) || '',
DataFrameFormatter.formatShape(df.shape),
DataFrameFormatter.formatMemorySize(df.memory_usage)
].join(' ').toLowerCase();

const matchesSearch = !searchTerm || searchFields.includes(searchTerm);

// Status filter
const status = DataFrameFormatter.getStatusBadge(df);
const matchesStatus = !statusFilter || status.class === statusFilter;

return matchesSearch && matchesStatus;
});

sortDataFrames();
renderDataFrames();

// Update search results count
updateSearchResultsCount();
}

function updateSearchResultsCount() {
const tableTitle = document.querySelector('.table-title');
const totalCount = dataframes.length;
const filteredCount = filteredDataframes.length;

if (filteredCount === totalCount) {
tableTitle.textContent = `DataFrames (${totalCount})`;
} else {
tableTitle.textContent = `DataFrames (${filteredCount} of ${totalCount})`;
}
}

// Enhanced rendering with better performance for large datasets
function renderDataFrames() {
const tbody = document.getElementById('dataframes-table-body');

if (filteredDataframes.length === 0) {
document.getElementById('dataframes-table').style.display = 'none';
document.getElementById('empty-state').style.display = 'block';
return;
}

document.getElementById('dataframes-table').style.display = 'table';
document.getElementById('empty-state').style.display = 'none';

// Use document fragment for better performance
const fragment = document.createDocumentFragment();

filteredDataframes.forEach(df => {
const row = document.createElement('tr');
row.className = 'dataframe-row';
row.onclick = () => viewDataFrame(df.df_id);

const status = DataFrameFormatter.getStatusBadge(df);
const memoryFormatted = DataFrameFormatter.formatMemorySize(df.memory_usage);
const createdDate = DataFrameFormatter.formatDate(df.created_at);
const source = DataFrameFormatter.truncateText(df.source || 'Unknown', 30);
const shape = DataFrameFormatter.formatShape(df.shape);

// Calculate memory bar percentage (max 100MB = 100%)
const memoryPercentage = Math.min(100, (df.memory_usage / (100 * 1024 * 1024)) * 100);

row.innerHTML = `
<td><strong>${df.df_id}</strong></td>
<td>${createdDate}</td>
<td>${shape}</td>
<td>
    <div style="display: flex; align-items: center; gap: 0.5em;">
        ${memoryFormatted}
        <div class="memory-bar">
            <div class="memory-fill" style="width: ${memoryPercentage}%"></div>
        </div>
    </div>
</td>
<td><span class="status-badge status-${status.class}">${status.text}</span></td>
<td title="${df.source || 'Unknown'}">${source}</td>
<td onclick="event.stopPropagation()">
    <div class="action-buttons">
        <button class="btn btn-primary btn-sm" onclick="viewDataFrame('${df.df_id}')">View</button>
        <button class="btn btn-danger btn-sm" onclick="deleteDataFrame('${df.df_id}')">Delete</button>
    </div>
</td>
`;

fragment.appendChild(row);
});

// Clear and append all at once for better performance
tbody.innerHTML = '';
tbody.appendChild(fragment);

updateSearchResultsCount();
}

// Enhanced sorting with better data type handling
function sortDataFrames() {
filteredDataframes.sort((a, b) => {
let aVal, bVal;

switch (sortColumn) {
case 'df_id':
aVal = a.df_id.toLowerCase();
bVal = b.df_id.toLowerCase();
break;
case 'created_at':
aVal = new Date(a.created_at);
bVal = new Date(b.created_at);
break;
case 'shape':
aVal = a.shape[0] * a.shape[1];
bVal = b.shape[0] * b.shape[1];
break;
case 'memory_usage':
aVal = a.memory_usage;
bVal = b.memory_usage;
break;
case 'status':
// Sort by status priority: active < warning < expired const statusPriority={ 'active' : 0, 'warning' : 1, 'expired' : 2
    }; aVal=statusPriority[DataFrameFormatter.getStatusBadge(a).class] || 0;
    bVal=statusPriority[DataFrameFormatter.getStatusBadge(b).class] || 0; break; case 'source' : aVal=(a.source || ''
    ).toLowerCase(); bVal=(b.source || '' ).toLowerCase(); break; default: return 0; } if (aVal < bVal) return
    sortDirection==='asc' ? -1 : 1; if (aVal> bVal) return sortDirection === 'asc' ? 1 : -1;
    return 0;
    });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (event) {
    // Ctrl/Cmd + R: Refresh
    if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
    event.preventDefault();
    refreshDashboard();
    }

    // Ctrl/Cmd + L: Load data
    if ((event.ctrlKey || event.metaKey) && event.key === 'l') {
    event.preventDefault();
    showLoadDataModal();
    }

    // Escape: Close modals
    if (event.key === 'Escape') {
    document.querySelectorAll('.modal').forEach(modal => {
    if (modal.style.display === 'block') {
    hideModal(modal.id);
    }
    });
    }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function () {
    stopAutoRefresh();
    });
    </script>
    {% endblock %}e, 'error');
    }
    }

    // Confirmation modal
    function confirmAction() {
    if (pendingAction) {
    pendingAction();
    pendingAction = null;
    }
    hideModal('confirm-modal');
    }

    // Utility functions
    function showStatus(elementId, message, isError = false) {
    const element = document.getElementById(elementId);
    if (element) {
    element.textContent = message;
    element.style.color = isError ? '#dc3545' : '#28a745';
    element.style.display = 'block';
    }
    }

    function clearStatus(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
    element.textContent = '';
    element.style.display = 'none';
    }
    }
    </script>
    {% endblock %}
