{% extends "base.html" %}

{% block title %}DataFrames - MCP Knowledge Server{% endblock %}

{% block extra_styles %}
<style>
    /* DataFrame Dashboard Styles */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2em;
        flex-wrap: wrap;
        gap: 1em;
    }

    .dashboard-title {
        margin: 0;
        color: #333;
    }

    .dashboard-actions {
        display: flex;
        gap: 0.5em;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.5em 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5em;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: #0077cc;
        color: white;
    }

    .btn-primary:hover {
        background: #005fa3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    /* Statistics Cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1em;
        margin-bottom: 2em;
    }

    .stat-card {
        background: #fff;
        padding: 1.5em;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-left: 4px solid #0077cc;
    }

    .stat-card.warning {
        border-left-color: #ffc107;
    }

    .stat-card.danger {
        border-left-color: #dc3545;
    }

    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin: 0;
    }

    .stat-label {
        color: #666;
        margin: 0.5em 0 0 0;
        font-size: 0.9em;
    }

    /* DataFrame Table */
    .dataframes-table-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table-header {
        background: #f8f9fa;
        padding: 1em;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1em;
    }

    .table-title {
        margin: 0;
        color: #333;
        font-size: 1.1em;
    }

    .table-controls {
        display: flex;
        gap: 0.5em;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-input {
        padding: 0.4em 0.8em;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9em;
        min-width: 200px;
    }

    .dataframes-table {
        width: 100%;
        border-collapse: collapse;
    }

    .dataframes-table th,
    .dataframes-table td {
        padding: 0.75em;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .dataframes-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #333;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .dataframes-table th:hover {
        background: #e9ecef;
    }

    .sort-indicator {
        position: absolute;
        right: 0.5em;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.5;
        font-size: 0.8em;
    }

    .sort-indicator.active {
        opacity: 1;
        color: #0077cc;
    }

    .dataframes-table tr:hover {
        background: #f8f9fa;
    }

    .dataframe-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .dataframe-row:hover {
        background: #f0f8ff !important;
    }

    /* Status indicators */
    .status-badge {
        padding: 0.25em 0.5em;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-expired {
        background: #f8d7da;
        color: #721c24;
    }

    .status-warning {
        background: #fff3cd;
        color: #856404;
    }

    /* Memory usage bars */
    .memory-bar {
        width: 100px;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .memory-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        transition: width 0.3s ease;
    }

    /* Action buttons in table */
    .action-buttons {
        display: flex;
        gap: 0.25em;
    }

    .btn-sm {
        padding: 0.25em 0.5em;
        font-size: 0.8em;
        border-radius: 3px;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 3em;
        color: #666;
    }

    .empty-state-icon {
        font-size: 3em;
        margin-bottom: 0.5em;
        opacity: 0.5;
    }

    /* Loading state */
    .loading {
        text-align: center;
        padding: 2em;
        color: #666;
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0077cc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5em;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: stretch;
        }

        .dashboard-actions {
            justify-content: center;
        }

        .stats-container {
            grid-template-columns: 1fr;
        }

        .table-header {
            flex-direction: column;
            align-items: stretch;
        }

        .table-controls {
            justify-content: center;
        }

        .search-input {
            min-width: auto;
            width: 100%;
        }

        .dataframes-table {
            font-size: 0.9em;
        }

        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h2 class="dashboard-title">DataFrames Dashboard</h2>
        <div class="dashboard-actions">
            <button class="btn btn-success" onclick="showLoadDataModal()">
                üìÅ Load Data
            </button>
            <button class="btn btn-warning" onclick="cleanupExpired()">
                üßπ Cleanup Expired
            </button>
            <button class="btn btn-secondary" onclick="refreshDashboard()">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Storage Statistics -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value" id="total-dataframes">-</div>
            <div class="stat-label">Total DataFrames</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-memory">-</div>
            <div class="stat-label">Memory Usage (MB)</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="expired-count">-</div>
            <div class="stat-label">Expired DataFrames</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avg-size">-</div>
            <div class="stat-label">Average Size (MB)</div>
        </div>
    </div>

    <!-- DataFrames Table -->
    <div class="dataframes-table-container">
        <div class="table-header">
            <h3 class="table-title">DataFrames</h3>
            <div class="table-controls">
                <input type="text" class="search-input" id="search-input" placeholder="Search DataFrames..."
                    onkeyup="filterDataFrames()">
                <select class="btn btn-secondary" id="status-filter" onchange="filterDataFrames()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="warning">Expiring Soon</option>
                </select>
            </div>
        </div>

        <div id="loading-indicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            Loading DataFrames...
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üìä</div>
            <h3>No DataFrames Found</h3>
            <p>Get started by loading your first dataset!</p>
            <button class="btn btn-primary" onclick="showLoadDataModal()">Load Data</button>
        </div>

        <table class="dataframes-table" id="dataframes-table" style="display: none;">
            <thead>
                <tr>
                    <th onclick="sortTable('df_id')">
                        ID
                        <span class="sort-indicator" id="sort-df_id">‚Üï</span>
                    </th>
                    <th onclick="sortTable('created_at')">
                        Created
                        <span class="sort-indicator" id="sort-created_at">‚Üï</span>
                    </th>
                    <th onclick="sortTable('shape')">
                        Shape (Rows √ó Cols)
                        <span class="sort-indicator" id="sort-shape">‚Üï</span>
                    </th>
                    <th onclick="sortTable('memory_usage')">
                        Memory Usage
                        <span class="sort-indicator" id="sort-memory_usage">‚Üï</span>
                    </th>
                    <th onclick="sortTable('status')">
                        Status
                        <span class="sort-indicator" id="sort-status">‚Üï</span>
                    </th>
                    <th onclick="sortTable('source')">
                        Source
                        <span class="sort-indicator" id="sort-source">‚Üï</span>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="dataframes-table-body">
            </tbody>
        </table>
    </div>
</div>

<!-- Load Data Modal -->
<div id="load-data-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Load New Data</h3>

        <div style="margin-bottom: 2em;">
            <label>
                <input type="radio" name="load-method" value="file" checked onchange="toggleLoadMethod()">
                Upload File
            </label>
            <label style="margin-left: 2em;">
                <input type="radio" name="load-method" value="url" onchange="toggleLoadMethod()">
                Load from URL
            </label>
        </div>

        <!-- File Upload Section -->
        <div id="file-upload-section">
            <div style="margin-bottom: 1em;">
                <label for="file-input">Select File:</label>
                <input type="file" id="file-input" accept=".csv,.json,.xlsx,.xls,.parquet"
                    style="width: 100%; margin-top: 0.5em;">
            </div>

            <div style="margin-bottom: 1em;">
                <label for="file-format">Format:</label>
                <select id="file-format" style="width: 100%; margin-top: 0.5em;">
                    <option value="auto">Auto-detect</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                    <option value="parquet">Parquet</option>
                </select>
            </div>
        </div>

        <!-- URL Loading Section -->
        <div id="url-load-section" style="display: none;">
            <div style="margin-bottom: 1em;">
                <label for="data-url">Data URL:</label>
                <input type="url" id="data-url" placeholder="https://example.com/data.csv"
                    style="width: 100%; margin-top: 0.5em;">
            </div>

            <div style="margin-bottom: 1em;">
                <label for="url-format">Format:</label>
                <select id="url-format" style="width: 100%; margin-top: 0.5em;">
                    <option value="auto">Auto-detect</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                    <option value="parquet">Parquet</option>
                </select>
            </div>
        </div>

        <!-- Common Options -->
        <div style="margin-bottom: 1em;">
            <label for="display-name">Display Name (optional):</label>
            <input type="text" id="display-name" placeholder="My Dataset" style="width: 100%; margin-top: 0.5em;">
        </div>

        <div style="margin-bottom: 2em;">
            <label>
                <input type="checkbox" id="has-header" checked>
                First row contains headers
            </label>
        </div>

        <div style="text-align: right;">
            <button class="btn btn-secondary" onclick="hideModal('load-data-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="loadData()" style="margin-left: 0.5em;">Load Data</button>
        </div>

        <div id="load-status" style="margin-top: 1em; display: none;"></div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="confirm-title">Confirm Action</h3>
        <p id="confirm-message">Are you sure you want to proceed?</p>
        <div style="text-align: right; margin-top: 2em;">
            <button class="btn btn-secondary" onclick="hideModal('confirm-modal')">Cancel</button>
            <button class="btn btn-danger" id="confirm-button" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables
    let dataframes = [];
    let filteredDataframes = [];
    let sortColumn = 'created_at';
    let sortDirection = 'desc';
    let pendingAction = null;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        loadDataFrames();
    });

    // Load DataFrames from API
    async function loadDataFrames() {
        showLoading(true);
        try {
            const response = await fetch('/api/dataframes');
            const data = await response.json();

            if (data.success) {
                dataframes = data.dataframes || [];
                updateStatistics(data.storage_stats || {});
                filteredDataframes = [...dataframes];
                sortDataFrames();
                renderDataFrames();
            } else {
                showStatus('Error loading DataFrames: ' + (data.error || 'Unknown error'), true);
            }
        } catch (error) {
            console.error('Error loading DataFrames:', error);
            showStatus('Error loading DataFrames: ' + error.message, true);
        } finally {
            showLoading(false);
        }
    }

    // Update statistics display
    function updateStatistics(stats) {
        document.getElementById('total-dataframes').textContent = stats.total_dataframes || 0;
        document.getElementById('total-memory').textContent = (stats.total_memory_mb || 0).toFixed(1);
        document.getElementById('expired-count').textContent = stats.expired_count || 0;

        const avgSize = stats.total_dataframes > 0 ?
            (stats.total_memory_mb / stats.total_dataframes) : 0;
        document.getElementById('avg-size').textContent = avgSize.toFixed(1);
    }

    // Show/hide loading indicator
    function showLoading(show) {
        document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
        document.getElementById('dataframes-table').style.display = show ? 'none' : (filteredDataframes.length > 0 ? 'table' : 'none');
        document.getElementById('empty-state').style.display = show ? 'none' : (filteredDataframes.length === 0 ? 'block' : 'none');
    }

    // Render DataFrames table
    function renderDataFrames() {
        const tbody = document.getElementById('dataframes-table-body');
        tbody.innerHTML = '';

        if (filteredDataframes.length === 0) {
            document.getElementById('dataframes-table').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            return;
        }

        document.getElementById('dataframes-table').style.display = 'table';
        document.getElementById('empty-state').style.display = 'none';

        filteredDataframes.forEach(df => {
            const row = document.createElement('tr');
            row.className = 'dataframe-row';
            row.onclick = () => viewDataFrame(df.df_id);

            const status = getDataFrameStatus(df);
            const memoryMB = (df.memory_usage / (1024 * 1024)).toFixed(1);
            const createdDate = new Date(df.created_at).toLocaleDateString();
            const source = df.source ? df.source.substring(0, 30) + (df.source.length > 30 ? '...' : '') : 'Unknown';

            row.innerHTML = `
                <td><strong>${df.df_id}</strong></td>
                <td>${createdDate}</td>
                <td>${df.shape[0].toLocaleString()} √ó ${df.shape[1]}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        ${memoryMB} MB
                        <div class="memory-bar">
                            <div class="memory-fill" style="width: ${Math.min(100, (df.memory_usage / (100 * 1024 * 1024)) * 100)}%"></div>
                        </div>
                    </div>
                </td>
                <td><span class="status-badge status-${status.class}">${status.text}</span></td>
                <td title="${df.source || 'Unknown'}">${source}</td>
                <td onclick="event.stopPropagation()">
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="viewDataFrame('${df.df_id}')">View</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDataFrame('${df.df_id}')">Delete</button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    // Get DataFrame status
    function getDataFrameStatus(df) {
        if (df.is_expired) {
            return { class: 'expired', text: 'Expired' };
        }

        if (df.expires_at) {
            const expiresAt = new Date(df.expires_at);
            const now = new Date();
            const hoursUntilExpiry = (expiresAt - now) / (1000 * 60 * 60);

            if (hoursUntilExpiry < 24) {
                return { class: 'warning', text: 'Expiring Soon' };
            }
        }

        return { class: 'active', text: 'Active' };
    }

    // Sort DataFrames
    function sortTable(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }

        updateSortIndicators();
        sortDataFrames();
        renderDataFrames();
    }

    function sortDataFrames() {
        filteredDataframes.sort((a, b) => {
            let aVal, bVal;

            switch (sortColumn) {
                case 'df_id':
                    aVal = a.df_id;
                    bVal = b.df_id;
                    break;
                case 'created_at':
                    aVal = new Date(a.created_at);
                    bVal = new Date(b.created_at);
                    break;
                case 'shape':
                    aVal = a.shape[0] * a.shape[1];
                    bVal = b.shape[0] * b.shape[1];
                    break;
                case 'memory_usage':
                    aVal = a.memory_usage;
                    bVal = b.memory_usage;
                    break;
                case 'status':
                    aVal = getDataFrameStatus(a).text;
                    bVal = getDataFrameStatus(b).text;
                    break;
                case 'source':
                    aVal = a.source || '';
                    bVal = b.source || '';
                    break;
                default:
                    return 0;
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function updateSortIndicators() {
        // Reset all indicators
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.textContent = '‚Üï';
            indicator.classList.remove('active');
        });

        // Set active indicator
        const activeIndicator = document.getElementById(`sort-${sortColumn}`);
        if (activeIndicator) {
            activeIndicator.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
            activeIndicator.classList.add('active');
        }
    }

    // Filter DataFrames
    function filterDataFrames() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        filteredDataframes = dataframes.filter(df => {
            // Text search
            const matchesSearch = !searchTerm ||
                df.df_id.toLowerCase().includes(searchTerm) ||
                (df.source && df.source.toLowerCase().includes(searchTerm)) ||
                (df.tags && df.tags.display_name && df.tags.display_name.toLowerCase().includes(searchTerm));

            // Status filter
            const status = getDataFrameStatus(df);
            const matchesStatus = !statusFilter || status.class === statusFilter;

            return matchesSearch && matchesStatus;
        });

        sortDataFrames();
        renderDataFrames();
    }

    // Navigation functions
    function viewDataFrame(dfId) {
        window.location.href = `/dataframes/${dfId}`;
    }

    function refreshDashboard() {
        loadDataFrames();
    }

    // Load data modal functions
    function showLoadDataModal() {
        showModal('load-data-modal');
    }

    function toggleLoadMethod() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        document.getElementById('file-upload-section').style.display = method === 'file' ? 'block' : 'none';
        document.getElementById('url-load-section').style.display = method === 'url' ? 'block' : 'none';
    }

    async function loadData() {
        const method = document.querySelector('input[name="load-method"]:checked').value;
        const displayName = document.getElementById('display-name').value;
        const hasHeader = document.getElementById('has-header').checked;

        clearStatus('load-status');

        try {
            let response;

            if (method === 'file') {
                const fileInput = document.getElementById('file-input');
                const format = document.getElementById('file-format').value;

                if (!fileInput.files[0]) {
                    showStatus('load-status', 'Please select a file', true);
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('format', format);
                formData.append('has_header', hasHeader);
                if (displayName) formData.append('display_name', displayName);

                response = await fetch('/api/dataframes/upload', {
                    method: 'POST',
                    body: formData
                });
            } else {
                const url = document.getElementById('data-url').value;
                const format = document.getElementById('url-format').value;

                if (!url) {
                    showStatus('load-status', 'Please enter a URL', true);
                    return;
                }

                response = await fetch('/api/dataframes/load-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        format: format,
                        has_header: hasHeader,
                        display_name: displayName
                    })
                });
            }

            const data = await response.json();

            if (data.success) {
                showStatus('load-status', 'Data loaded successfully!', false);
                setTimeout(() => {
                    hideModal('load-data-modal');
                    loadDataFrames();
                }, 1500);
            } else {
                showStatus('load-status', 'Error: ' + (data.error || 'Unknown error'), true);
            }
        } catch (error) {
            console.error('Error loading data:', error);
            showStatus('load-status', 'Error: ' + error.message, true);
        }
    }

    // Delete DataFrame
    function deleteDataFrame(dfId) {
        pendingAction = () => performDelete(dfId);
        document.getElementById('confirm-title').textContent = 'Delete DataFrame';
        document.getElementById('confirm-message').textContent = `Are you sure you want to delete DataFrame "${dfId}"? This action cannot be undone.`;
        showModal('confirm-modal');
    }

    async function performDelete(dfId) {
        try {
            const response = await fetch(`/api/dataframes/${dfId}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (data.success) {
                loadDataFrames();
            } else {
                alert('Error deleting DataFrame: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting DataFrame:', error);
            alert('Error deleting DataFrame: ' + error.message);
        }
    }

    // Cleanup expired DataFrames
    function cleanupExpired() {
        pendingAction = performCleanup;
        document.getElementById('confirm-title').textContent = 'Cleanup Expired DataFrames';
        document.getElementById('confirm-message').textContent = 'Are you sure you want to delete all expired DataFrames? This action cannot be undone.';
        showModal('confirm-modal');
    }

    async function performCleanup() {
        try {
            const response = await fetch('/api/dataframes/cleanup', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                alert(`Cleanup completed. Removed ${data.removed_count} DataFrames, freed ${data.memory_freed_mb.toFixed(1)} MB.`);
                loadDataFrames();
            } else {
                alert('Error during cleanup: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error during cleanup:', error);
            alert('Error during cleanup: ' + error.message);
        }
    }

    // Confirmation modal
    function confirmAction() {
        if (pendingAction) {
            pendingAction();
            pendingAction = null;
        }
        hideModal('confirm-modal');
    }

    // Utility functions
    function showStatus(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = message;
            element.style.color = isError ? '#dc3545' : '#28a745';
            element.style.display = 'block';
        }
    }

    function clearStatus(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = '';
            element.style.display = 'none';
        }
    }
</script>
{% endblock %}
